---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import Comments from '../../../components/Comments.astro';

export async function getStaticPaths() {
  const instructions = await getCollection('instructions');
  
  return instructions.map((entry) => {
    const pathParts = entry.slug.split('/');
    const make = pathParts[0];
    const model = pathParts[1];
    const year = pathParts[2];
    
    return {
      params: { make, model, year },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const { title, description, make, model, years, difficulty, timeMinutes, author, pubDate } = entry.data;

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: make, href: `/${Astro.params.make}/` },
  { label: model, href: `/${Astro.params.make}/${Astro.params.model}/` },
  { label: years },
];

const difficultyConfig: Record<string, { color: string; label: string }> = {
  easy: { color: 'text-green-600', label: 'Easy' },
  medium: { color: 'text-yellow-600', label: 'Medium' },
  hard: { color: 'text-red-600', label: 'Hard' },
};

const diffStyle = difficultyConfig[difficulty] || difficultyConfig.easy;
---

<BaseLayout title={title} description={description}>
  <Breadcrumbs items={breadcrumbs} />

  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">{title}</h1>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <!-- Content Header -->
          <div class="bg-primary text-white px-6 py-4">
            <h2 class="text-lg font-semibold flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
              </svg>
              Programming Instructions
            </h2>
          </div>
          
          <!-- Instructions Content -->
          <div class="p-6">
            <div class="instruction-content" id="instruction-content">
              <Content />
            </div>
          </div>
          
          <!-- Content Footer -->
          <div class="bg-gray-50 px-6 py-4 border-t flex items-center justify-between no-print">
            <p class="text-sm text-gray-500">
              ðŸ’¡ <strong>Tip:</strong> If it doesn't work, try again â€” timing can be tricky!
            </p>
            <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-700 transition">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
              </svg>
              Print
            </button>
          </div>
        </div>
        
        <!-- Troubleshooting Link -->
        <div class="mt-6 bg-blue-50 rounded-xl p-6 no-print">
          <h3 class="font-semibold text-gray-900 mb-2">Having trouble?</h3>
          <p class="text-gray-600 text-sm mb-4">
            Check our troubleshooting guide for common issues and solutions.
          </p>
          <a href="/troubleshooting/" class="text-primary hover:underline font-medium text-sm">
            View Troubleshooting Guide â†’
          </a>
        </div>
        
        <!-- Comments -->
        <div class="no-print">
          <Comments pageId={entry.slug} pageTitle={title} />
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1 no-print">
        <div class="bg-white rounded-xl shadow-sm sticky top-4">
          <div class="bg-gray-50 px-5 py-4 border-b rounded-t-xl">
            <h3 class="font-bold text-gray-900">Quick Info</h3>
          </div>
          <div class="p-5">
            <dl class="space-y-4 text-sm">
              <div class="flex justify-between items-center">
                <dt class="text-gray-500">Vehicle</dt>
                <dd class="font-medium text-gray-800">{make} {model}</dd>
              </div>
              <div class="flex justify-between items-center">
                <dt class="text-gray-500">Year</dt>
                <dd class="font-medium text-gray-800">{years}</dd>
              </div>
              <div class="flex justify-between items-center">
                <dt class="text-gray-500">Time</dt>
                <dd class="font-medium text-gray-800">~{timeMinutes} min</dd>
              </div>
              <div class="flex justify-between items-center">
                <dt class="text-gray-500">Difficulty</dt>
                <dd class={`${diffStyle.color} font-medium`}>{diffStyle.label}</dd>
              </div>
            </dl>
          </div>
          <div class="px-5 py-4 border-t bg-green-50 rounded-b-xl">
            <p class="text-sm text-green-800">
              <strong>You save:</strong> $100+ vs locksmith
            </p>
          </div>
        </div>
        
        <!-- Need Help Card -->
        <div class="mt-4 bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-gray-900 mb-3">Need Professional Help?</h3>
          <p class="text-gray-600 text-sm mb-4">
            Some vehicles require special equipment.
          </p>
          <a href="/find-a-locksmith/" class="block text-center bg-primary text-white py-2 rounded-lg font-medium hover:bg-accent transition text-sm">
            Find a Locksmith
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON-LD Schema -->
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "HowTo",
      "name": title,
      "description": description,
      "totalTime": `PT${timeMinutes}M`,
      "tool": ["Key fob", "Vehicle key"],
      "supply": ["New key fob with fresh battery"]
    })} />
  </Fragment>
</BaseLayout>

<script>
  // Convert paragraph text into numbered steps
  document.addEventListener('DOMContentLoaded', () => {
    const content = document.getElementById('instruction-content');
    if (!content) return;
    
    const paragraphs = content.querySelectorAll('p');
    let stepNumber = 1;
    
    paragraphs.forEach((p, index) => {
      const text = p.textContent || '';
      
      // Skip intro paragraphs (short or contain "learn to", "programming", "note:", etc.)
      const isIntro = text.length < 100 && (
        text.toLowerCase().includes('learn to') ||
        text.toLowerCase().includes('programming') ||
        text.toLowerCase().includes('instructions') ||
        text.toLowerCase().startsWith('note')
      );
      
      if (isIntro && index === 0) {
        // Style as intro
        p.className = 'text-gray-600 mb-6 pb-4 border-b';
        return;
      }
      
      // Split by sentences that look like steps
      const sentences = text.split(/\.(?=\s|$)/).filter(s => s.trim().length > 0);
      
      if (sentences.length > 1) {
        // Create steps list
        const ol = document.createElement('ol');
        ol.className = 'space-y-4';
        
        sentences.forEach(sentence => {
          const trimmed = sentence.trim();
          if (trimmed.length < 5) return;
          
          const li = document.createElement('li');
          li.className = 'flex gap-4';
          li.innerHTML = `
            <span class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold text-sm">${stepNumber}</span>
            <span class="text-gray-700 pt-1">${trimmed}.</span>
          `;
          ol.appendChild(li);
          stepNumber++;
        });
        
        p.replaceWith(ol);
      } else if (text.trim().length > 10) {
        // Single sentence - still make it a step
        const ol = document.createElement('ol');
        ol.className = 'space-y-4';
        const li = document.createElement('li');
        li.className = 'flex gap-4';
        li.innerHTML = `
          <span class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold text-sm">${stepNumber}</span>
          <span class="text-gray-700 pt-1">${text.trim()}</span>
        `;
        ol.appendChild(li);
        p.replaceWith(ol);
        stepNumber++;
      }
    });
  });
</script>

<style>
  .instruction-content {
    color: #374151;
    line-height: 1.75;
  }
</style>
