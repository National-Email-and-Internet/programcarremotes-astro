---
import { getCollection } from 'astro:content';

// Get all instructions to build the data
const instructions = await getCollection('instructions');

// Build make -> model -> years map
const makeModelYears: Record<string, Record<string, string[]>> = {};

instructions.forEach(i => {
  const parts = i.slug.split('/');
  const [make, model, year] = parts;
  
  if (!makeModelYears[make]) {
    makeModelYears[make] = {};
  }
  if (!makeModelYears[make][model]) {
    makeModelYears[make][model] = [];
  }
  makeModelYears[make][model].push(year);
});

// Sort everything
Object.keys(makeModelYears).forEach(make => {
  Object.keys(makeModelYears[make]).forEach(model => {
    makeModelYears[make][model].sort();
  });
});

const makes = Object.keys(makeModelYears).sort();
---

<div class="bg-white rounded-2xl p-6 shadow-2xl max-w-2xl mx-auto">
  <form id="search-form">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      
      <!-- Make -->
      <div>
        <label for="make" class="block text-left text-sm font-medium text-gray-600 mb-2">
          Make
        </label>
        <select 
          id="make" 
          name="make"
          class="w-full px-4 py-3 rounded-lg border border-gray-200 text-gray-800 bg-gray-50 focus:ring-2 focus:ring-accent focus:border-accent transition"
        >
          <option value="">Select Make</option>
          {makes.map(make => (
            <option value={make}>{make.charAt(0).toUpperCase() + make.slice(1)}</option>
          ))}
        </select>
      </div>
      
      <!-- Model -->
      <div>
        <label for="model" class="block text-left text-sm font-medium text-gray-600 mb-2">
          Model
        </label>
        <select 
          id="model" 
          name="model"
          class="w-full px-4 py-3 rounded-lg border border-gray-200 text-gray-800 bg-gray-50 focus:ring-2 focus:ring-accent focus:border-accent transition"
          disabled
        >
          <option value="">Select Make first</option>
        </select>
      </div>
      
      <!-- Year -->
      <div>
        <label for="year" class="block text-left text-sm font-medium text-gray-600 mb-2">
          Year
        </label>
        <select 
          id="year" 
          name="year"
          class="w-full px-4 py-3 rounded-lg border border-gray-200 text-gray-800 bg-gray-50 focus:ring-2 focus:ring-accent focus:border-accent transition"
          disabled
        >
          <option value="">Select Model first</option>
        </select>
      </div>
    </div>
    
    <button 
      type="submit"
      id="search-btn"
      class="w-full bg-accent hover:bg-green-600 text-white font-semibold py-4 rounded-xl transition flex items-center justify-center gap-2 text-lg disabled:opacity-50 disabled:cursor-not-allowed"
      disabled
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      Find My Instructions
    </button>
  </form>
</div>

<script define:vars={{ makeModelYears }}>
  const data = makeModelYears;
  
  const makeSelect = document.getElementById('make');
  const modelSelect = document.getElementById('model');
  const yearSelect = document.getElementById('year');
  const searchBtn = document.getElementById('search-btn');
  const form = document.getElementById('search-form');
  
  // When make changes, populate models
  makeSelect?.addEventListener('change', () => {
    const make = makeSelect.value;
    
    if (make && data[make]) {
      const models = Object.keys(data[make]).sort();
      modelSelect.innerHTML = '<option value="">Select Model</option>' + 
        models.map(m => `<option value="${m}">${m.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</option>`).join('');
      modelSelect.disabled = false;
    } else {
      modelSelect.innerHTML = '<option value="">Select Make first</option>';
      modelSelect.disabled = true;
    }
    
    yearSelect.innerHTML = '<option value="">Select Model first</option>';
    yearSelect.disabled = true;
    searchBtn.disabled = true;
  });
  
  // When model changes, populate years
  modelSelect?.addEventListener('change', () => {
    const make = makeSelect.value;
    const model = modelSelect.value;
    
    if (make && model && data[make] && data[make][model]) {
      const years = data[make][model].sort((a, b) => b.localeCompare(a)); // Descending
      yearSelect.innerHTML = '<option value="">Select Year</option>' + 
        years.map(y => `<option value="${y}">${y === 'unknown' ? 'All Years' : y}</option>`).join('');
      yearSelect.disabled = false;
    } else {
      yearSelect.innerHTML = '<option value="">Select Model first</option>';
      yearSelect.disabled = true;
    }
    searchBtn.disabled = true;
  });
  
  // When year changes, enable button
  yearSelect?.addEventListener('change', () => {
    searchBtn.disabled = !yearSelect.value;
  });
  
  // Handle form submit - direct redirect
  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const make = makeSelect.value;
    const model = modelSelect.value;
    const year = yearSelect.value;
    
    if (make && model && year) {
      window.location.href = `/${make}/${model}/${year}/`;
    }
  });
</script>
